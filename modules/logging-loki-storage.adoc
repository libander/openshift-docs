// Module is included in the following assemblies:
// logging/logging-loki-ocp.adoc
//
:_content-type: PROCEDURE
[id="logging-loki-storage_{context}"]
= Loki log storage

The Loki Operator supports link:https://aws.amazon.com/[AWS S3], as well as other S3 compatible object stores such as link:https://min.io/[Minio] and link:https://www.redhat.com/en/technologies/cloud-computing/openshift-data-foundation[OpenShift Data Foundation]. link:https://azure.microsoft.com[Azure], link:https://cloud.google.com/[GCS], and link:https://docs.openstack.org/swift/latest/[Swift] are also supported.

The recommended nomenclature for Loki storage is `logging-loki-<type>`. General secret creation format is as follows:
//Generic secret creation
include::snippets/logging-create-secret-snip.adoc[]

You can verify a secret has been created by running the following command:

[source,terminal]
----
oc get secrets
----

The table below displays the `type` values within the `LokiStack` CR for each storage provider. For more detailed information, consult the section for your storage provider.

[options="header"]
.Secret type quick reference
|================================================
| Storage provider          | Secret `type` value
| AWS                       | s3
| Azure                     | azure
| Google Cloud              | gcs
| Minio                     | s3
| OpenShift Data Foundation | s3
| Swift                     | swift
|================================================

== AWS S3

.Prerequisites
* Loki Operator deployed
* Create a link:https://docs.aws.amazon.com/AmazonS3/latest/userguide/create-bucket-overview.html[bucket] on AWS.

.Procedure
* Create an Object Storage secret with keys as follows:

[source,terminal]
----
oc create secret generic logging-loki-s3 \
  --from-literal=bucketnames="<BUCKET_NAME>" \
  --from-literal=endpoint="<AWS_BUCKET_ENDPOINT>" \
  --from-literal=access_key_id="<AWS_ACCESS_KEY_ID>" \
  --from-literal=access_key_secret="<AWS_ACCESS_KEY_SECRET>" \
  --from-literal=region="<AWS_REGION_OF_YOUR_BUCKET>"
----

** Suggested secret name: `logging-loki-s3`

** Secret type: `s3`

== Azure

.Prerequisites
* Loki Operator deployed
* Create a link:https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction[bucket] on Azure.

.Procedure
* Create an Object Storage secret with keys as follows:

[source,terminal]
----
oc create secret generic logging-loki-azure \
  --from-literal=container="<AZURE_CONTAINER_NAME>" \
  --from-literal=environment="<AZURE_ENVIRONMENT>" \ # <1>
  --from-literal=account_name="<AZURE_ACCOUNT_NAME>" \
  --from-literal=account_key="<AZURE_ACCOUNT_KEY>"
----
<1> Supported values are: AzureGlobal, AzureChinaCloud, AzureGermanCloud, AzureUSGovernment.

** Suggested secret name: `logging-loki-azure`

** Secret type: `azure`


== Google Cloud Storage

.Prerequisites

* Loki Operator deployed

* Create a link:https://cloud.google.com/resource-manager/docs/creating-managing-projects[project] on Google Cloud Platform.

* Create a link:https://cloud.google.com/storage/docs/creating-buckets[bucket] under same project.

* Create a link:https://cloud.google.com/docs/authentication/getting-started#creating_a_service_account[service account] under same project for GCP authentication.

.Procedure

. Copy the service account credentials received from GCP into a file name `key.json`.

. Create an Object Storage secret with keys `bucketname` and `key.json` as follows:

+
[source,terminal]
----
oc create secret generic logging-loki-gcs \
  --from-literal=bucketname="<BUCKET_NAME>" \
  --from-file=key.json="<PATH/TO/KEY.JSON>"
----

Where `logging-loki-gcs` is the secret name, `<BUCKET_NAME>` is the name of bucket created in prerequisites step and `<PATH/TO/KEY.JSON>` is the file path where the `key.json` was copied to.

** Suggested secret name: `logging-loki-gcs`

** Secret type: `gcs`


== Minio

.Prerequisites

* Loki Operator deployed

* link:https://operator.min.io/[Minio] deployed on your Cluster.

* Create a link:https://docs.min.io/docs/minio-client-complete-guide.html[bucket] on Minio via CLI.

.Procedure

* Create an Object Storage secret with keys as follows:

[source,terminal]
----
oc create secret generic logging-loki-minio \
  --from-literal=bucketnames="<BUCKET_NAME>" \
  --from-literal=endpoint="<MINIO_BUCKET_ENDPOINT>" \
  --from-literal=access_key_id="<MINIO_ACCESS_KEY_ID>" \
  --from-literal=access_key_secret="<MINIO_ACCESS_KEY_SECRET>"
----

** Suggested secret name: `logging-loki-minio`

** Secret type: `s3`


== OpenShift Data Foundation

.Prerequisites

* Loki Operator deployed

* Deploy the [OpenShift Data Foundation](https://access.redhat.com/documentation/en-us/red_hat_openshift_data_foundation/4.12) on your cluster.

.Procedure

. Create an ObjectBucketClaim in `openshift-logging` namespace:
+
[source,yaml]
----
apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: loki-bucket-odf
  namespace: openshift-logging
spec:
  generateBucketName: loki-bucket-odf
  storageClassName: openshift-storage.noobaa.io
----

. Get bucket properties from the associated ConfigMap:
+
[source,terminal]
----
BUCKET_HOST=$(oc get -n openshift-logging configmap loki-bucket-odf -o jsonpath='{.data.BUCKET_HOST}')
BUCKET_NAME=$(oc get -n openshift-logging configmap loki-bucket-odf -o jsonpath='{.data.BUCKET_NAME}')
BUCKET_PORT=$(oc get -n openshift-logging configmap loki-bucket-odf -o jsonpath='{.data.BUCKET_PORT}')
----

. Get bucket access key from the associated Secret:
+
[source,terminal]
----
ACCESS_KEY_ID=$(oc get -n openshift-logging secret loki-bucket-odf -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
SECRET_ACCESS_KEY=$(oc get -n openshift-logging secret loki-bucket-odf -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)
----

.. Create an Object Storage secret with keys as follows:
+
[source,terminal]
----
oc create -n openshift-logging secret generic logging-loki-odf \
--from-literal=access_key_id="${ACCESS_KEY_ID}" \
--from-literal=access_key_secret="${SECRET_ACCESS_KEY}" \
--from-literal=bucketnames="${BUCKET_NAME}" \
--from-literal=endpoint="https://${BUCKET_HOST}:${BUCKET_PORT}"
----

Where `logging-loki-odf` is the secret name. The values for `ACCESS_KEY_ID`, `SECRET_ACCESS_KEY`, `BUCKET_NAME`, `BUCKET_HOST` and `BUCKET_PORT` are taken from your ObjectBucketClaim's accompanied secret and ConfigMap.

** Suggested secret name: `logging-loki-odf`

** Secret type: `s3`


== Swift

.Prerequisites

* Loki Operator deployed

* Create a https://docs.openstack.org/newton/user-guide/cli-swift-create-containers.html[bucket] on Swift.

.Procedure

* Create an Object Storage secret with keys as follows:

[source,terminal]
----
oc create secret generic logging-loki-swift \
  --from-literal=auth_url="<SWIFT_AUTH_URL>" \
  --from-literal=username="<SWIFT_USERNAMEClaim>" \
  --from-literal=user_domain_name="<SWIFT_USER_DOMAIN_NAME>" \
  --from-literal=user_domain_id="<SWIFT_USER_DOMAIN_ID>" \
  --from-literal=user_id="<SWIFT_USER_ID>" \
  --from-literal=password="<SWIFT_PASSWORD>" \
  --from-literal=domain_id="<SWIFT_DOMAIN_ID>" \
  --from-literal=domain_name="<SWIFT_DOMAIN_NAME>" \
  --from-literal=container_name="<SWIFT_CONTAINER_NAME>"
----

Optionally you can provide project-specific data and/or a region as follows:

[source,terminal]
----
oc create secret generic logging-loki-swift \
  --from-literal=auth_url="<SWIFT_AUTH_URL>" \
  --from-literal=username="<SWIFT_USERNAMEClaim>" \
  --from-literal=user_domain_name="<SWIFT_USER_DOMAIN_NAME>" \
  --from-literal=user_domain_id="<SWIFT_USER_DOMAIN_ID>" \
  --from-literal=user_id="<SWIFT_USER_ID>" \
  --from-literal=password="<SWIFT_PASSWORD>" \
  --from-literal=domain_id="<SWIFT_DOMAIN_ID>" \
  --from-literal=domain_name="<SWIFT_DOMAIN_NAME>" \
  --from-literal=container_name="<SWIFT_CONTAINER_NAME>" \
  --from-literal=project_id="<SWIFT_PROJECT_ID>" \
  --from-literal=project_name="<SWIFT_PROJECT_NAME>" \
  --from-literal=project_domain_id="<SWIFT_PROJECT_DOMAIN_ID>" \
  --from-literal=project_domain_name="<SWIFT_PROJECT_DOMAIN_name>" \
  --from-literal=region="<SWIFT_REGION>"
----

** Suggested secret name: `logging-loki-swift`

** Secret type: `swift`
